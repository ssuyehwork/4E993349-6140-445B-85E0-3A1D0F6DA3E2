# 截图工具功能重构与视觉修复计划

由于前期修复逻辑导致选取与编辑状态绘制冲突（出现多余蓝点句柄），本计划将对 [ScreenshotTool](file:///g:/C++/Inspirenote/Inspirenote_release/src/ui/ScreenshotTool.h#99-175) 进行重构，建立清晰的状态机管理逻辑。

## Proposed Changes

### 1. 核心状态机重构 [ScreenshotTool.h/cpp]

> [!IMPORTANT]
> 将截图流程划分为三个主状态，避免逻辑交叉。

*   **状态定义：**
    *   `State_Idle`: 正在检测窗口，准备开始截图。
    *   `State_Selecting`: 正在拖拽鼠标设定初始截图区域。
    *   `State_Editing`: 区域已选定，正在拖动、缩放或使用工具（画笔、箭头、马赛克等）。
*   **交互逻辑优化：**
    *   在 `State_Selecting` 时，明确不绘制 8 个缩放句柄。
    *   在 `State_Editing` 时，只有在“无工具活动”或“移动模式”下显示句柄。
    *   绘制标注时（画笔、矩形等），隐藏句柄以减少视觉干扰。

### 2. 渲染流程隔离 [ScreenshotTool.cpp]

*   **重构 [paintEvent](file:///g:/C++/Inspirenote/Inspirenote_release/src/ui/ScreenshotTool.cpp#781-805)：**
    ```mermaid
    graph TD
        A[绘制底图] --> B[绘制遮罩层]
        B --> C{当前状态?}
        C -- Selecting --> D[绘制虚线选框]
        C -- Editing --> E[绘制选区内容]
        E --> F[绘制已有标注]
        F --> G[绘制当前活动标注]
        G --> H{是否显示句柄?}
        H -- 是 --> I[绘制 8 个蓝圈句柄]
    ```

### 3. 修复马赛克与选区逻辑 [ScreenshotTool.cpp]

*   **自窗口过滤：** 确保 [detectWindows](file:///g:/C++/Inspirenote/Inspirenote_release/src/ui/ScreenshotTool.cpp#923-931) 彻底排除掉当前透明捕捉层，防止其干扰底层窗口识别。
*   **句柄坐标对齐：** 修正高 DPI 下句柄点击位置的微小偏移问题。

---

## Verification Plan

### Automated Tests
*   由于涉及视觉和原生 Windows 事件，将通过日志记录状态转换过程进行逻辑验证。

### Manual Verification
1.  **选取阶段：** 拖选鼠标创建区域，确认过程中**不出现**任何白色或蓝色的小圆点句柄。
2.  **编辑阶段：**
    *   释放鼠标后，圆点句柄立即出现。
    *   选择箭头工具并绘制，观察句柄是否暂时消失以方便看清标注内容。
3.  **重构验证：** 确认撤销/重做、OCR、保存功能依然正常。
